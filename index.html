<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>YouBike 每小時在站車輛數（含調度模擬）</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family:"Microsoft JhengHei",Arial; margin:20px; }
.section { border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:12px; }
label { display:inline-block; width:150px; }
input { padding:6px; margin:4px 0; }
canvas { max-height:420px; }

table { border-collapse:collapse; width:100%; margin-top:8px; }
th,td { border:1px solid #ccc; padding:4px 6px; text-align:center; }
.overUp { background:#f8d7da; }
.overDown { background:#dbeafe; }
</style>
</head>

<body>

<h2>YouBike 每小時在站車輛數（含調度模擬）</h2>

<div class="section">
  <b>① 上傳 Excel（雙北配置線上版 v1.xlsx → 每小時變化）</b><br>
  <input type="file" id="fileInput" accept=".xlsx">
</div>

<div class="section">
  <label>場站</label>
  <input list="stations" id="station"><br>

  <label>責任區</label>
  <input id="area" readonly>
  <label>總車位</label>
  <input id="capacity" readonly><br>

  <label>5 點車輛數</label>
  <input type="number" id="init" value="0"><br>

  <label>10–15 點調度數量</label>
  <input type="number" id="dispatch15" value="0"><br>

  <label>21–24 點調度數量</label>
  <input type="number" id="dispatch21" value="0">
</div>

<datalist id="stations"></datalist>

<div class="section">
  <canvas id="chart"></canvas>
</div>

<div class="section">
  <h3>逐時在站車輛數（實際值）</h3>
  <div id="dataTable"></div>
</div>

<script>
let DB = [];
const HOURS = [5, ...Array.from({length:18},(_,i)=>i+6)];
let chart = null;

fileInput.addEventListener("change", loadExcel);
station.addEventListener("change", refresh);
init.addEventListener("input", refresh);
dispatch15.addEventListener("input", refresh);
dispatch21.addEventListener("input", refresh);

function loadExcel(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, { type:"array" });
    const ws = wb.Sheets["每小時變化"];
    if(!ws){ alert("找不到工作表：每小時變化"); return; }

    const rows = XLSX.utils.sheet_to_json(ws);
    DB = rows.map(r => ({
      station: r["場站"],
      area: r["責任區"],
      capacity: Number(r["總車位數"]),
      deltas: Object.fromEntries(
        Array.from({length:18},(_,i)=>[i+6, Number(r[i+6])])
      )
    }));

    stations.innerHTML = DB.map(d => `<option value="${d.station}">`).join("");
    alert("Excel 載入完成");
  };
  reader.readAsArrayBuffer(file);
}

function refresh(){
  if(DB.length === 0) return;

  const rec = DB.find(d => d.station === station.value);
  if(!rec) return;

  const base = Number(init.value);
  const d15 = Number(dispatch15.value);
  const d21 = Number(dispatch21.value);

  area.value = rec.area;
  capacity.value = rec.capacity;

  const upper = rec.capacity;
  const lower = -rec.capacity * 2;

  const actual = [];
  const plot = [];
  const overUp = [];
  const overDown = [];

  function handle(hour, natural){
    let v = base + natural;
    if(hour >= 15) v += d15;
    if(hour >= 21) v += d21;

    actual.push(v);

    if(v > upper){
      plot.push(upper); overUp.push(v); overDown.push(null);
    }else if(v < lower){
      plot.push(lower); overUp.push(null); overDown.push(v);
    }else{
      plot.push(v); overUp.push(null); overDown.push(null);
    }
  }

  handle(5, 0);
  for(let h=6; h<=23; h++){
    handle(h, rec.deltas[h]);
  }

  drawChart(plot, overUp, overDown, upper, lower, rec.station);
  drawTable(actual, rec.capacity, upper, lower);
}

/* drawChart、drawTable 與你上一版完全相同，為節省篇幅略 */
</script>

</body>
</html>
