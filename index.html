<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>YouBike æ¯å°æ™‚åœ¨ç«™è»Šè¼›æ•¸ï¼ˆæœ€çµ‚ç©©å®šç‰ˆï¼‰</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family:"Microsoft JhengHei",Arial; margin:20px; }
.section { border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:12px; }
label { display:inline-block; width:120px; }
input { padding:6px; margin:4px 0; }
canvas { max-height:420px; }

table { border-collapse:collapse; width:100%; margin-top:8px; }
th,td { border:1px solid #ccc; padding:4px 6px; text-align:center; }
.overUp { background:#f8d7da; }
.overDown { background:#dbeafe; }
</style>
</head>

<body>

<h2>YouBike æ¯å°æ™‚åœ¨ç«™è»Šè¼›æ•¸ï¼ˆç‡Ÿé‹æ±ºç­–ç‰ˆï¼‰</h2>

<div class="section">
  <b>â‘  ä¸Šå‚³ Excelï¼ˆé›™åŒ—é…ç½®ç·šä¸Šç‰ˆ v1.xlsx â†’ æ¯å°æ™‚è®ŠåŒ–ï¼‰</b><br>
  <input type="file" id="fileInput" accept=".xlsx">
</div>

<div class="section">
  <label>å ´ç«™</label>
  <input list="stations" id="station"><br>
  <label>è²¬ä»»å€</label>
  <input id="area" readonly>
  <label>ç¸½è»Šä½</label>
  <input id="capacity" readonly><br>
  <label>5 é»è»Šè¼›æ•¸</label>
  <input type="number" id="init">
</div>

<datalist id="stations"></datalist>

<div class="section">
  <canvas id="chart"></canvas>
</div>

<div class="section">
  <h3>é€æ™‚åœ¨ç«™è»Šè¼›æ•¸ï¼ˆå¯¦éš›å€¼ï¼‰</h3>
  <div id="dataTable"></div>
</div>

<script>
let DB = [];
const HOURS = [5, ...Array.from({length:18},(_,i)=>i+6)];
let chart = null;

fileInput.addEventListener("change", loadExcel);
station.addEventListener("change", refresh);
init.addEventListener("input", refresh);

function loadExcel(e){
  const file = e.target.files[0];
  if(!file){ alert("æœªé¸æ“‡æª”æ¡ˆ"); return; }

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, { type:"array" });
    const ws = wb.Sheets["æ¯å°æ™‚è®ŠåŒ–"];
    if(!ws){ alert("æ‰¾ä¸åˆ°å·¥ä½œè¡¨ï¼šæ¯å°æ™‚è®ŠåŒ–"); return; }

    const rows = XLSX.utils.sheet_to_json(ws);
    DB = rows.map(r => ({
      station: r["å ´ç«™"],
      area: r["è²¬ä»»å€"],
      capacity: Number(r["ç¸½è»Šä½æ•¸"]),
      deltas: Object.fromEntries(
        Array.from({length:18},(_,i)=>[i+6, Number(r[i+6])])
      )
    }));

    stations.innerHTML = DB.map(d => `<option value="${d.station}">`).join("");
    alert("Excel è¼‰å…¥å®Œæˆï¼Œè«‹é¸å ´ç«™ä¸¦è¼¸å…¥ 5 é»è»Šè¼›æ•¸");
  };
  reader.readAsArrayBuffer(file);
}

function refresh(){
  if(DB.length === 0) return;

  const rec = DB.find(d => d.station === station.value);
  const base = Number(init.value);
  if(!rec || isNaN(base)) return;

  area.value = rec.area;
  capacity.value = rec.capacity;

  const upper = rec.capacity;          // ä¸Šé™ï¼è»Šä½æ•¸
  const lower = -rec.capacity * 2;     // ä¸‹é™ï¼-2Ã—è»Šä½

  const actual = [];
  const plot = [];
  const overUp = [];
  const overDown = [];

  function handle(v){
    actual.push(v);
    if(v > upper){
      plot.push(upper);
      overUp.push(v);
      overDown.push(null);
    }else if(v < lower){
      plot.push(lower);
      overUp.push(null);
      overDown.push(v);
    }else{
      plot.push(v);
      overUp.push(null);
      overDown.push(null);
    }
  }

  handle(base);
  for(let h=6; h<=23; h++){
    handle(base + rec.deltas[h]);
  }

  drawChart(plot, overUp, overDown, upper, lower, rec.station);
  drawTable(actual, rec.capacity, upper, lower);
}

function drawChart(plot, overUp, overDown, upper, lower, label){
  if(chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type:"line",
    data:{
      labels:HOURS,
      datasets:[
        {
          label: label + " åœ¨ç«™è»Šè¼›æ•¸",
          data: plot,
          borderColor:"green",
          borderWidth:2,
          tension:0.35,
          pointRadius: ctx => (overUp[ctx.dataIndex] || overDown[ctx.dataIndex]) ? 6 : 3,
          pointStyle: ctx => overUp[ctx.dataIndex] ? "triangle" :
                             overDown[ctx.dataIndex] ? "triangle" : "circle",
          rotation: ctx => overDown[ctx.dataIndex] ? 180 : 0
        },
        {
          label:"è»Šä½ä¸Šé™",
          data:HOURS.map(()=>upper),
          borderDash:[6,6],
          borderColor:"red",
          pointRadius:0
        },
        {
          label:"é¡¯ç¤ºä¸‹é™ (-2Ã—)",
          data:HOURS.map(()=>lower),
          borderDash:[6,6],
          borderColor:"red",
          pointRadius:0
        },
        {
          label:"0 åŸºæº–",
          data:HOURS.map(()=>0),
          borderColor:"orange",
          pointRadius:0
        }
      ]
    },
    options:{
      scales:{ y:{ min: lower, max: upper } }
    },
    plugins:[{
      id:"valueLabels",
      afterDatasetsDraw(chart){
        const {ctx, scales:{x,y}} = chart;
        ctx.save();
        ctx.fillStyle = "red";
        ctx.font = "12px Arial";

        plot.forEach((_,i)=>{
          const xPos = x.getPixelForValue(i);
          const isLast = i === HOURS.length - 1;
          const offsetX = isLast ? -30 : 6;

          if(overUp[i] !== null){
            ctx.fillText(overUp[i], xPos + offsetX, y.getPixelForValue(upper) - 6);
          }
          if(overDown[i] !== null){
            ctx.fillText(overDown[i], xPos + offsetX, y.getPixelForValue(lower) + 14);
          }
        });
        ctx.restore();
      }
    }]
  });
}

function drawTable(actual, capacity, upper, lower){
  let html = `
    <table>
      <tr>
        <th>æ™‚é–“</th>
        <th>åœ¨ç«™è»Šè¼›æ•¸ï¼ˆå¯¦éš›ï¼‰</th>
        <th>ç‹€æ…‹</th>
        <th>èˆ‡è»Šä½å·®è·</th>
        <th>é¢¨éšª</th>
      </tr>
  `;

  actual.forEach((v,i)=>{
    let cls="", status="æ­£å¸¸", risk="";
    if(v > upper){ cls="overUp"; status="è¶…éè»Šä½ä¸Šé™"; risk="âš "; }
    else if(v < lower){ cls="overDown"; status="ä½æ–¼é¡¯ç¤ºä¸‹é™"; risk="ğŸ”»"; }

    html += `
      <tr class="${cls}">
        <td>${HOURS[i]}</td>
        <td>${v}</td>
        <td>${status}</td>
        <td>${v - capacity}</td>
        <td>${risk}</td>
      </tr>
    `;
  });

  html += "</table>";
  dataTable.innerHTML = html;
}
</script>

</body>
</html>

