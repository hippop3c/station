<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>YouBike 每小時在站車輛數（GitHub 穩定版）</title>

<!-- GitHub Pages Stable Build -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family:"Microsoft JhengHei",Arial; margin:20px; }
.section { border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:12px; }
label { display:inline-block; width:190px; }
input { padding:6px; margin:4px 0; }
button { padding:6px 10px; margin-top:6px; cursor:pointer; }
small { color:#555; }
canvas { max-height:420px; }

table { border-collapse:collapse; width:100%; margin-top:8px; }
th,td { border:1px solid #ccc; padding:4px 6px; text-align:center; }
.overUp { background:#f8d7da; }
.overDown { background:#dbeafe; }
.msg { padding:8px 10px; background:#f6f6f6; border-radius:6px; margin-top:8px; white-space:pre-line; }
</style>
</head>

<body>

<h2>YouBike 每小時在站車輛數（含調度模擬）</h2>

<div class="section">
  <b>① 上傳 Excel（雙北配置線上版 v1.xlsx → 每小時變化）</b><br>
  <input type="file" id="fileInput" accept=".xlsx">
  <div id="loadMsg" class="msg" style="display:none;"></div>
</div>

<div class="section">
  <label>場站</label>
  <input list="stations" id="station"><br>

  <label>責任區</label>
  <input id="area" readonly>
  <label>總車位</label>
  <input id="capacity" readonly><br>

  <label>5 點車輛數</label>
  <input type="number" id="init" value="0"><br>

  <label>10–15 點調度數量</label>
  <input type="number" id="dispatch15" value="0"><br>

  <label>21–24 點調度數量</label>
  <input type="number" id="dispatch21" value="0"><br>

  <button id="btnSolve">一鍵試算最佳解（優先調度 = 0）</button>
  <div id="solveMsg" class="msg" style="display:none;"></div>
</div>

<datalist id="stations"></datalist>

<div class="section">
  <canvas id="chartCanvas"></canvas>
</div>

<div class="section">
  <h3>逐時在站車輛數（實際值）</h3>
  <div id="dataTable"></div>
</div>

<script>
/* ================= 基本資料 ================= */
let DB = [];
const HOURS = [5, ...Array.from({length:18},(_,i)=>i+6)];
let chart = null;

/* ================= 事件綁定 ================= */
fileInput.addEventListener("change", loadExcel);
station.addEventListener("change", refresh);
init.addEventListener("input", refresh);
dispatch15.addEventListener("input", refresh);
dispatch21.addEventListener("input", refresh);
btnSolve.addEventListener("click", autoSolve);

/* ================= 工具 ================= */
function showMsg(el, txt){
  el.style.display = "block";
  el.textContent = txt;
}
function safeNum(v){
  return Number.isFinite(v) ? v : null;
}
function clamp(x, lo, hi){
  return x < lo ? lo : (x > hi ? hi : x);
}

/* ================= Excel 載入 ================= */
function loadExcel(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, { type:"array" });
    const ws = wb.Sheets["每小時變化"];
    if(!ws){ alert("找不到工作表：每小時變化"); return; }

    const rows = XLSX.utils.sheet_to_json(ws);
    if(rows.length === 0){
      alert("Excel 讀取成功，但沒有資料列，請檢查欄位名稱");
      return;
    }

    DB = rows.map(r => ({
      station: r["場站"],
      area: r["責任區"],
      capacity: Number(r["總車位數"]),
      start5: safeNum(Number(r["5起始車輛"])),
      deltas: Object.fromEntries(
        Array.from({length:18},(_,i)=>[i+6, Number(r[i+6])])
      )
    }));

    stations.innerHTML = DB.map(d => `<option value="${d.station}">`).join("");
    showMsg(loadMsg, `Excel 載入完成：${DB.length} 筆場站`);
  };
  reader.readAsArrayBuffer(file);
}

/* ================= 在站計算 ================= */
function computeSeries(rec, base, D15, D21){
  const arr = [];
  arr.push(base);
  for(let h=6; h<=23; h++){
    let v = base + rec.deltas[h];
    if(h >= 15) v += D15;
    if(h >= 21) v += D21;
    arr.push(v);
  }
  return arr;
}

/* ================= 一鍵試算最佳解 ================= */
function autoSolve(){
  if(DB.length === 0){ alert("請先上傳 Excel"); return; }
  const rec = DB.find(d => d.station === station.value);
  if(!rec){ alert("請先選擇場站"); return; }

  const C = rec.capacity;
  const preferB = safeNum(rec.start5);

  const H1 = Array.from({length:10},(_,i)=>i+5);
  const H2 = Array.from({length:6},(_,i)=>i+15);
  const H3 = [21,22,23];

  function bounds(hours){
    let lo = -1e18, hi = 1e18;
    for(const h of hours){
      const d = (h===5) ? 0 : rec.deltas[h];
      lo = Math.max(lo, -d + 1);
      hi = Math.min(hi, C - d - 1);
    }
    return [lo, hi];
  }

  function chooseB(lo, hi){
    if(lo > hi) return null;
    if(preferB !== null && lo <= preferB && preferB <= hi) return preferB;
    return Math.trunc((lo + hi) / 2);
  }

  const [A1,B1] = bounds(H1);
  let Lb = Math.max(1, A1);
  let Ub = Math.min(C-1, B1);
  if(Lb > Ub){
    showMsg(solveMsg,"【無解】5–14 已無法滿足 0 < 在站 < 車位");
    return;
  }

  const [A2,B2] = bounds(H2);
  const [A3,B3] = bounds(H3);

  let L0 = Math.max(Lb, A2, A3);
  let U0 = Math.min(Ub, B2, B3);
  if(L0 <= U0){
    const b = chooseB(L0,U0);
    init.value = b; dispatch15.value = 0; dispatch21.value = 0;
    showMsg(solveMsg,`✅ 最佳解存在（無需調度）
5 點配置：${b}`);
    refresh(); return;
  }

  let best = null;
  for(let D15=-C; D15<=C; D15++){
    let L12 = Math.max(Lb, A2-D15);
    let U12 = Math.min(Ub, B2-D15);
    if(L12 > U12) continue;

    let sumLo = A3-U12, sumHi = B3-L12;
    if(sumLo > sumHi) continue;

    let Dsum = clamp(D15,sumLo,sumHi);
    let D21 = Dsum - D15;
    let total = Math.abs(D15)+Math.abs(D21);

    let Lf = Math.max(L12, A3-Dsum);
    let Uf = Math.min(U12, B3-Dsum);
    if(Lf > Uf) continue;

    if(!best || total < best.total){
      best = {b:chooseB(Lf,Uf),D15,D21,total};
    }
  }

  if(!best){
    showMsg(solveMsg,"【無解】需列為結構性失衡站");
    return;
  }

  init.value = best.b;
  dispatch15.value = best.D15;
  dispatch21.value = best.D21;
  showMsg(solveMsg,`⚠ 已套用最小調度解
5 點=${best.b}
D15=${best.D15}、D21=${best.D21}`);
  refresh();
}

/* ================= 繪圖與表格 ================= */
function refresh(){
  if(DB.length === 0) return;
  const rec = DB.find(d => d.station === station.value);
  if(!rec) return;

  area.value = rec.area;
  capacity.value = rec.capacity;

  const base = Number(init.value)||0;
  const D15 = Number(dispatch15.value)||0;
  const D21 = Number(dispatch21.value)||0;

  const upper = rec.capacity;
  const lower = -rec.capacity*2;

  const actual = computeSeries(rec, base, D15, D21);
  const plot=[], up=[], down=[];
  actual.forEach(v=>{
    if(v>upper){plot.push(upper);up.push(v);down.push(null);}
    else if(v<lower){plot.push(lower);up.push(null);down.push(v);}
    else{plot.push(v);up.push(null);down.push(null);}
  });

  drawChart(plot,up,down,upper,lower,rec.station);
  drawTable(actual,rec.capacity,upper,lower);
}

function drawChart(plot,up,down,upper,lower,label){
  if(chart) chart.destroy();
  chart=new Chart(chartCanvas,{
    type:"line",
    data:{
      labels:HOURS,
      datasets:[
        {label:label,data:plot,borderColor:"green",tension:.35},
        {label:"車位上限",data:HOURS.map(()=>upper),borderDash:[6,6],borderColor:"red"},
        {label:"顯示下限",data:HOURS.map(()=>lower),borderDash:[6,6],borderColor:"red"},
        {label:"0 基準",data:HOURS.map(()=>0),borderColor:"orange"}
      ]
    },
    options:{scales:{y:{min:lower,max:upper}}},

    plugins:[{
      id:"valueLabels",
      afterDatasetsDraw(chart){
        const {ctx, scales:{x,y}} = chart;
        ctx.save();
        ctx.fillStyle = "red";
        ctx.font = "12px Arial";

        plot.forEach((_,i)=>{
          const xPos = x.getPixelForValue(i);
          const isLast = i === HOURS.length - 1;
          const offsetX = isLast ? -30 : 6;

          if(up[i] !== null){
            ctx.fillText(up[i], xPos + offsetX, y.getPixelForValue(upper) - 6);
          }
          if(down[i] !== null){
            ctx.fillText(down[i], xPos + offsetX, y.getPixelForValue(lower) + 14);
          }
        });
        ctx.restore();
      }
    }]

  });
}

function drawTable(actual,C,upper,lower){
  let h="<table><tr><th>時間</th><th>在站</th><th>狀態</th></tr>";
  actual.forEach((v,i)=>{
    let s="正常",c="";
    if(v>upper){s="超上限";c="overUp";}
    if(v<lower){s="低於下限";c="overDown";}
    h+=`<tr class="${c}"><td>${HOURS[i]}</td><td>${v}</td><td>${s}</td></tr>`;
  });
  dataTable.innerHTML=h+"</table>";
}
</script>

</body>
</html>
